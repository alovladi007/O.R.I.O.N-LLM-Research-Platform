NANO-OS Database Migrations
============================

This directory contains Alembic database migrations for the NANO-OS platform.

## Overview

Alembic manages database schema changes in a version-controlled manner, allowing
you to:
- Upgrade database schema to the latest version
- Downgrade to previous versions if needed
- Track all schema changes over time
- Maintain consistency across development, staging, and production environments

## Directory Structure

```
alembic/
├── env.py              # Migration environment configuration (async SQLAlchemy)
├── script.py.mako      # Template for generating new migration scripts
├── versions/           # Migration scripts directory
│   └── 001_initial_schema.py  # Initial database schema
└── README              # This file
```

## Prerequisites

1. PostgreSQL 12+ with pgvector extension installed
2. Python packages: alembic, sqlalchemy, asyncpg, pgvector
3. DATABASE_URL environment variable set (or configured in alembic.ini)

## Common Commands

### Apply All Pending Migrations (Upgrade to Latest)
```bash
alembic upgrade head
```

### View Current Migration Status
```bash
alembic current
```

### View Migration History
```bash
alembic history --verbose
```

### Downgrade One Version
```bash
alembic downgrade -1
```

### Downgrade to Specific Version
```bash
alembic downgrade <revision_id>
```

### Generate New Migration (Auto-detect Changes)
```bash
alembic revision --autogenerate -m "description of changes"
```

### Generate Empty Migration Template
```bash
alembic revision -m "description of changes"
```

## Initial Setup

For a fresh database, run:

```bash
# This will create all tables, indexes, and constraints
alembic upgrade head
```

## Environment Variables

The migrations use the `DATABASE_URL` environment variable if set. Otherwise,
it falls back to the default URL in alembic.ini.

Example:
```bash
export DATABASE_URL="postgresql+asyncpg://user:password@localhost:5432/dbname"
alembic upgrade head
```

## Creating New Migrations

When you modify models in `src/api/models/`, create a migration:

```bash
# Auto-generate migration based on model changes
alembic revision --autogenerate -m "add new column to materials table"

# Review the generated migration in alembic/versions/
# Edit if needed, then apply it
alembic upgrade head
```

## Important Notes

1. **pgvector Extension**: The initial migration and env.py automatically enable
   the pgvector extension required for vector embeddings.

2. **Async SQLAlchemy**: The migrations are configured to work with async
   SQLAlchemy (asyncpg driver).

3. **Production**: Always review auto-generated migrations before applying them
   in production. Alembic's autogenerate is helpful but not perfect.

4. **Backups**: Always backup your database before running migrations in production.

5. **Downgrade**: Not all migrations can be safely downgraded (e.g., dropping
   columns with data). Review downgrade() functions carefully.

## Migration Best Practices

1. **One Change Per Migration**: Keep migrations focused on a single logical change
2. **Test Locally First**: Test migrations on a development database before production
3. **Review Generated Code**: Always review autogenerated migrations
4. **Document Changes**: Use clear, descriptive migration messages
5. **Handle Data**: For complex changes, add data migration logic in upgrade()
6. **Reversibility**: Ensure downgrade() properly reverses upgrade()

## Troubleshooting

### "Target database is not up to date"
Run `alembic upgrade head` to apply pending migrations.

### "Can't locate revision identified by..."
The alembic_version table in your database is out of sync. You may need to
manually stamp the current version:
```bash
alembic stamp head
```

### pgvector Extension Missing
Install pgvector in PostgreSQL:
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### Connection Issues
Verify your DATABASE_URL is correct and the database is accessible:
```bash
psql $DATABASE_URL -c "SELECT version();"
```

## Support

For more information on Alembic:
- Official docs: https://alembic.sqlalchemy.org/
- Tutorial: https://alembic.sqlalchemy.org/en/latest/tutorial.html
- Auto-generate: https://alembic.sqlalchemy.org/en/latest/autogenerate.html
